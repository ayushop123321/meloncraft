<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Purchase - MelonCraft</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Security Meta Tags -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;">
    <meta name="referrer" content="no-referrer">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <img src="img/logo.png" alt="MelonCraft" class="logo">
                    <span class="logo-text">MelonCraft</span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">Home</a>
                    </li>
                    <li class="nav-item">
                        <a href="index.html#store" class="nav-link">Store</a>
                    </li>
                    <li class="nav-item">
                        <a href="quiz.html" class="nav-link">Quiz</a>
                    </li>
                    <li class="nav-item">
                        <a href="index.html#about" class="nav-link">About</a>
                    </li>
                    <li class="nav-item">
                        <a href="index.html#contact" class="nav-link">Contact</a>
                    </li>
                </ul>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Checkout Section -->
    <section class="checkout-section">
        <div class="container">
            <div class="checkout-container">
                <div class="checkout-header">
                    <i class="fas fa-shopping-cart"></i>
                    <h1>Complete Your Purchase</h1>
                </div>
                <p class="checkout-subtitle">Fill in the details to finalize your order</p>

                <div class="order-summary-card">
                    <h3 class="order-summary-title">Order Summary</h3>
                    <div class="order-info">
                        <div class="order-info-row">
                            <span class="info-label">Item Type:</span>
                            <span class="info-value" id="itemType">Rank</span>
                        </div>
                        <div class="order-info-row">
                            <span class="info-label">Item Name:</span>
                            <span class="info-value" id="itemName">Spider Man Rank</span>
                        </div>
                        <div class="order-info-row">
                            <span class="info-label">Total Amount:</span>
                            <span class="info-value price" id="itemPrice">₹450</span>
                        </div>
                    </div>
                </div>

                <div class="checkout-form-card">
                    <div class="form-group">
                        <label for="transactionId" class="form-label required">Transaction ID:</label>
                        <input type="text" id="transactionId" class="form-input" placeholder="Enter your UPI transaction ID">
                        <small class="form-help">Copy the transaction ID from your payment app</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="minecraftUsername" class="form-label required">Minecraft Username:</label>
                        <input type="text" id="minecraftUsername" class="form-input" placeholder="Enter your Minecraft username">
                        <small class="form-help">Make sure this is your exact in-game username</small>
                    </div>
                </div>

                <div class="checkout-buttons">
                    <a href="purchase.html" class="back-button">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                    <button id="completeButton" class="complete-button">
                        <i class="fas fa-check"></i> Complete Purchase
                    </button>
                </div>

                <div class="checkout-note">
                    <i class="fas fa-info-circle"></i>
                    <p>Your purchase will be processed within 5-10 minutes after submission. You'll receive your items directly in-game.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="img/logo.png" alt="MelonCraft" class="logo">
                    <span class="logo-text">MelonCraft</span>
                </div>
                <div class="footer-links">
                    <a href="index.html#home">Home</a>
                    <a href="index.html#store">Store</a>
                    <a href="index.html#about">About</a>
                    <a href="index.html#contact">Contact</a>
                </div>
                <div class="footer-socials">
                    <a href="https://discord.gg/ZUesr2VGGz" target="_blank" class="social-link">
                        <i class="fab fa-discord"></i>
                    </a>
                    <a href="https://www.youtube.com/@godbiltugaming" target="_blank" class="social-link">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; MelonCraft 2025 | All Rights Reserved</p>
            </div>
        </div>
    </footer>

    <!-- Load Firebase and OrderService -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="orderService.js"></script>
    
    <script>
        // Load purchase details from session storage
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize OrderService
            await OrderService.init();
            
            const purchaseDetails = JSON.parse(sessionStorage.getItem('purchaseDetails'));
            
            if (purchaseDetails) {
                document.getElementById('itemType').textContent = purchaseDetails.type;
                document.getElementById('itemName').textContent = purchaseDetails.name + ' ' + purchaseDetails.type;
                document.getElementById('itemPrice').textContent = '₹' + purchaseDetails.price;
            } else {
                // Redirect to store if no purchase details
                window.location.href = 'index.html#store';
            }

            // Complete purchase button
            document.getElementById('completeButton').addEventListener('click', function() {
                const transactionId = document.getElementById('transactionId').value.trim();
                const minecraftUsername = document.getElementById('minecraftUsername').value.trim();
                
                // Validate inputs
                if (!transactionId) {
                    alert('Please enter your transaction ID');
                    return;
                }
                
                if (!minecraftUsername) {
                    alert('Please enter your Minecraft username');
                    return;
                }
                
                // Disable button to prevent multiple submissions
                const completeButton = document.getElementById('completeButton');
                completeButton.disabled = true;
                completeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                // Store order details
                const orderDetails = {
                    ...purchaseDetails,
                    transactionId: transactionId,
                    minecraftUsername: minecraftUsername,
                    orderDate: new Date().toISOString()
                };
                
                // Save order details to session storage
                sessionStorage.setItem('orderDetails', JSON.stringify(orderDetails));
                
                // Create order for admin panel
                const orderId = '#MC-' + new Date().getFullYear() + '-' + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                
                const adminOrder = {
                    id: orderId,
                    date: new Date().toISOString(),
                    customer: minecraftUsername,
                    item: purchaseDetails.name,
                    amount: '₹' + purchaseDetails.price,
                    status: 'Pending',
                    timestamp: Date.now()
                };
                
                // Immediately redirect to processing page
                window.location.href = 'processing.html';
                
                // Save order in background after redirect
                setTimeout(function() {
                    // Try to save to Firebase
                    OrderService.addOrder(adminOrder).catch(function(error) {
                        console.error('Error saving order:', error);
                        
                        // Fallback to localStorage if Firebase fails
                        let orders = JSON.parse(localStorage.getItem('orders') || '[]');
                        orders.unshift(adminOrder);
                        localStorage.setItem('orders', JSON.stringify(orders));
                    });
                    
                    // Add notification
                    const notificationMessage = `New order received: ${purchaseDetails.name} by ${minecraftUsername}`;
                    const newNotification = {
                        id: Date.now(),
                        message: notificationMessage,
                        time: new Date().toLocaleTimeString(),
                        read: false
                    };
                    
                    let notifications = JSON.parse(localStorage.getItem('adminNotifications') || '[]');
                    notifications.unshift(newNotification);
                    localStorage.setItem('adminNotifications', JSON.stringify(notifications));
                }, 100);
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>